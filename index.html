<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Athlete Training System - Complete</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        h1 {
            text-align: center;
            font-size: 42px;
            margin-bottom: 10px;
            background: linear-gradient(to right, #ff6b35, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        /* CALENDAR */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .calendar-nav button {
            background: #333;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 5px;
            font-weight: bold;
        }
        
        .calendar-nav button:hover { background: #444; }
        
        .month-title {
            font-size: 28px;
            color: #00ff88;
            font-weight: bold;
        }
        
        .analysis-btn {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .analysis-btn:hover {
            transform: translateY(-2px);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 12px;
            color: #888;
            font-weight: bold;
            font-size: 14px;
        }
        
        .calendar-day {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 12px;
            min-height: 140px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .calendar-day:hover { 
            border-color: #666; 
            transform: translateY(-2px); 
        }
        
        .calendar-day.other-month { opacity: 0.3; }
        
        .calendar-day.today {
            border-color: #00ff88;
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.4);
            background: rgba(0, 255, 136, 0.05);
        }
        
        .calendar-day.has-workouts {
            border-color: #00ccff;
            background: rgba(0, 204, 255, 0.1);
        }
        
        .day-number {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .day-workouts {
            font-size: 11px;
            color: #aaa;
        }
        
        .workout-badge {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .cns-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #000;
        }
        
        .cns-low { background: #00ff88; }
        .cns-moderate { background: #ffaa00; }
        .cns-high { background: #ff4444; }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            max-width: 1400px;
            margin: 0 auto;
            background: #0a0a0a;
            border-radius: 12px;
            padding: 40px;
            border: 3px solid #00ff88;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .modal-title {
            font-size: 32px;
            color: #00ff88;
        }
        
        .close-btn {
            background: #ff4444;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .close-btn:hover { background: #ff6666; }
        
        /* MODALITY CHECKBOXES */
        .modality-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
            padding: 25px;
            background: #1a1a1a;
            border-radius: 12px;
        }
        
        .modality-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modality-checkbox:hover {
            border-color: #666;
        }
        
        .modality-checkbox.checked {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        
        .modality-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .modality-checkbox label {
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }
        
        /* MODALITY SECTIONS */
        .modality-section {
            background: #1a1a1a;
            border: 2px solid #00ccff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .modality-section h2 {
            color: #00ccff;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        /* FORMS */
        .exercise-block {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .exercise-name {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .exercise-name:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .muscle-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .muscle-select:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .set-label {
            color: #888;
            font-size: 14px;
            margin: 15px 0 8px 0;
            font-weight: bold;
        }
        
        .set-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 40px;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .set-row input, .set-row select {
            padding: 10px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            font-size: 15px;
        }
        
        .set-row input:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .delete-btn {
            background: transparent;
            border: none;
            color: #ff4444;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
        }
        
        .delete-btn:hover {
            color: #ff6666;
        }
        
        .add-btn {
            background: #2a2a2a;
            border: 2px dashed #444;
            color: #888;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .add-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }
        
        .add-exercise-btn {
            background: linear-gradient(135deg, #333, #1a1a1a);
            border: 2px solid #00ff88;
            color: #00ff88;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        
        .add-exercise-btn:hover {
            background: #0a2a1a;
        }
        
        .question {
            margin-bottom: 15px;
        }
        
        .question label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-weight: bold;
        }
        
        select, input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #0a0a0a;
            color: white;
            font-size: 15px;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .upload-zone {
            border: 2px dashed #333;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 15px 0;
        }
        
        .upload-zone:hover {
            border-color: #00ff88;
        }
        
        .upload-zone.has-file {
            border-color: #00ff88;
            border-style: solid;
            background: rgba(0, 255, 136, 0.05);
        }
        
        .hr-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .save-day-btn {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border: none;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
        }
        
        .save-day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }
        
        .rpe-btn {
            background: #444;
            border: 2px solid #666;
            color: #aaa;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .rpe-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }
        
        /* RPE MODAL */
        .rpe-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1001;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rpe-content {
            max-width: 600px;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            border: 2px solid #00ff88;
        }
        
        .rpe-row {
            display: grid;
            grid-template-columns: 80px 120px 1fr;
            gap: 15px;
            padding: 12px;
            margin-bottom: 8px;
            background: #0a0a0a;
            border-radius: 6px;
            align-items: center;
        }
        
        .rpe-number {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .rpe-rir {
            font-size: 14px;
            color: #00ccff;
            font-weight: bold;
        }
        
        .rpe-desc {
            font-size: 14px;
            color: #aaa;
        }
        
        /* METRICS DISPLAY */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #00ccff;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .metric-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .warning-box {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success-box {
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid #00ff88;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .info-box {
            background: rgba(0, 204, 255, 0.2);
            border: 2px solid #00ccff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            h1 { font-size: 28px; }
            .calendar-grid { gap: 5px; }
            .calendar-day { min-height: 100px; padding: 8px; }
            .day-number { font-size: 14px; }
            .modality-checkboxes { grid-template-columns: 1fr; }
            .set-row { grid-template-columns: 1fr 1fr 40px; }
            .modal-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ ELITE ATHLETE TRAINING SYSTEM</h1>
        <p class="subtitle">Full Periodization ‚Ä¢ Load Management ‚Ä¢ Injury Prevention ‚Ä¢ Performance Optimization</p>
        
        <div class="calendar-header">
            <div class="calendar-nav">
                <button onclick="previousMonth()">‚Äπ Prev</button>
                <button onclick="goToToday()">Today</button>
                <button onclick="nextMonth()">Next ‚Ä∫</button>
            </div>
            <div class="month-title" id="month-title">NOVEMBER 2025</div>
            <div style="display: flex; gap: 10px;">
                <button class="analysis-btn" onclick="showWeeklyAnalysis()">
                    üìä WEEKLY ANALYSIS
                </button>
                <button class="analysis-btn" onclick="showHelp()" style="background: #333;">
                    ‚ùì HELP
                </button>
            </div>
        </div>
        
        <div style="background: #1a1a1a; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #333;">
            <p style="color: #888; font-size: 13px; margin: 0;">
                <strong style="color: #00ff88;">Quick Tips:</strong> 
                Click empty day to log workout ‚Ä¢ 
                Click completed day to view details ‚Ä¢ 
                Right-click or Ctrl+Click for detailed view ‚Ä¢ 
                Type exercise name for auto-progression suggestions
            </p>
        </div>
        
        <div class="calendar-grid" id="calendar-grid"></div>
        
        <div id="day-modal" class="hidden"></div>
        <div id="weekly-modal" class="hidden"></div>
        <div id="rpe-modal" class="hidden"></div>
    </div>
    
    <script>
        // ========== STATE ==========
        let currentDate = new Date();
        let trainingData = {}; // { 'YYYY-MM-DD': { modalities: {...}, totalCNS, totalVolume, tss, hrData } }
        let historicalTSS = []; // Last 28 days for A:C ratio
        let exerciseCounters = {};
        let setCounters = {};
        let exerciseHistory = {}; // { 'Bench Press': [{date, sets: [{weight, reps, rpe}]}] }
        
        // Load/Save
        function loadData() {
            const saved = localStorage.getItem('eliteTrainingData');
            if (saved) trainingData = JSON.parse(saved);
            
            const savedTSS = localStorage.getItem('historicalTSS');
            if (savedTSS) historicalTSS = JSON.parse(savedTSS);
            
            const savedHistory = localStorage.getItem('exerciseHistory');
            if (savedHistory) exerciseHistory = JSON.parse(savedHistory);
        }
        
        function saveData() {
            localStorage.setItem('eliteTrainingData', JSON.stringify(trainingData));
            localStorage.setItem('historicalTSS', JSON.stringify(historicalTSS));
            localStorage.setItem('exerciseHistory', JSON.stringify(exerciseHistory));
        }
        
        // Update exercise history
        function updateExerciseHistory(dateStr, exercises) {
            exercises.forEach(ex => {
                if (!exerciseHistory[ex.name]) {
                    exerciseHistory[ex.name] = [];
                }
                exerciseHistory[ex.name].push({
                    date: dateStr,
                    muscleGroup: ex.muscleGroup,
                    sets: ex.workingSets
                });
                // Keep last 20 sessions per exercise
                if (exerciseHistory[ex.name].length > 20) {
                    exerciseHistory[ex.name].shift();
                }
            });
        }
        
        // Get last workout for exercise
        function getLastWorkout(exerciseName) {
            if (!exerciseHistory[exerciseName] || exerciseHistory[exerciseName].length === 0) {
                return null;
            }
            return exerciseHistory[exerciseName][exerciseHistory[exerciseName].length - 1];
        }
        
        // Suggest progression
        function suggestProgression(exerciseName, lastSets) {
            if (!lastSets || lastSets.length === 0) return null;
            
            // Get best set (highest weight √ó reps)
            const bestSet = lastSets.reduce((best, set) => {
                const volume = set.weight * set.reps;
                const bestVolume = best.weight * best.reps;
                return volume > bestVolume ? set : best;
            });
            
            const suggestions = [];
            
            // Strategy 1: Same weight, more reps
            if (bestSet.reps < 12) {
                suggestions.push({
                    type: 'volume',
                    weight: bestSet.weight,
                    reps: bestSet.reps + 1,
                    desc: 'Add 1 rep (volume progression)'
                });
            }
            
            // Strategy 2: More weight, same reps
            const increment = bestSet.weight >= 200 ? 5 : 2.5;
            suggestions.push({
                type: 'intensity',
                weight: bestSet.weight + increment,
                reps: bestSet.reps,
                desc: `Add ${increment} lbs (intensity progression)`
            });
            
            // Strategy 3: Deload if RPE was too high
            if (bestSet.rpe >= 9.5) {
                suggestions.push({
                    type: 'deload',
                    weight: Math.round(bestSet.weight * 0.9),
                    reps: bestSet.reps,
                    desc: 'Deload 10% (RPE too high last time)'
                });
            }
            
            return { lastBest: bestSet, suggestions };
        }
        
        // ========== CALENDAR ==========
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
                               'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];
            document.getElementById('month-title').textContent = `${monthNames[month]} ${year}`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const today = formatDate(new Date());
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const date = new Date(year, month - 1, day);
                createDayCell(grid, date, true, today);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                createDayCell(grid, date, false, today);
            }
            
            const totalCells = firstDay + daysInMonth;
            const remainingCells = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                createDayCell(grid, date, true, today);
            }
        }
        
        function createDayCell(grid, date, otherMonth, today) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            if (otherMonth) cell.classList.add('other-month');
            
            const dateStr = formatDate(date);
            
            if (dateStr === today) cell.classList.add('today');
            
            const dayData = trainingData[dateStr];
            
            const dayNum = document.createElement('div');
            dayNum.className = 'day-number';
            dayNum.textContent = date.getDate();
            cell.appendChild(dayNum);
            
            if (dayData && dayData.modalities) {
                cell.classList.add('has-workouts');
                
                const workouts = document.createElement('div');
                workouts.className = 'day-workouts';
                
                Object.keys(dayData.modalities).forEach(type => {
                    if (dayData.modalities[type].completed) {
                        const badge = document.createElement('span');
                        badge.className = 'workout-badge';
                        badge.textContent = type.toUpperCase();
                        workouts.appendChild(badge);
                    }
                });
                
                cell.appendChild(workouts);
                
                const totalCNS = dayData.totalCNS || 0;
                const indicator = document.createElement('div');
                indicator.className = 'cns-indicator';
                if (totalCNS < 60) indicator.classList.add('cns-low');
                else if (totalCNS < 75) indicator.classList.add('cns-moderate');
                else indicator.classList.add('cns-high');
                cell.appendChild(indicator);
                
                // Historical view (right-click or ctrl+click)
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    viewHistoricalDay(dateStr, date, dayData);
                });
                
                // Regular click opens edit
                cell.onclick = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        viewHistoricalDay(dateStr, date, dayData);
                    } else {
                        openDay(dateStr, date);
                    }
                };
            } else {
                // No workout yet - open for new entry
                cell.onclick = () => openDay(dateStr, date);
            }
            
            grid.appendChild(cell);
        }
        
        // View completed workout details
        function viewHistoricalDay(dateStr, date, dayData) {
            let html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üìã ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="success-box">
                            <h3 style="color: #00ff88;">TRAINING COMPLETED</h3>
                            <p><strong>Modalities:</strong> ${Object.keys(dayData.modalities).map(t => t.toUpperCase()).join(', ')}</p>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value">${dayData.totalCNS}</div>
                                <div class="metric-label">Total CNS Load</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${dayData.totalVolume.toLocaleString()}</div>
                                <div class="metric-label">Volume (lbs)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${dayData.tss}</div>
                                <div class="metric-label">Training Stress Score</div>
                            </div>
                        </div>
            `;
            
            // Show details for each modality
            Object.keys(dayData.modalities).forEach(type => {
                const mod = dayData.modalities[type];
                html += `<div class="modality-section">`;
                html += `<h2>${type.toUpperCase()}</h2>`;
                
                if (type === 'chest' || type === 'back' || type === 'legs') {
                    if (mod.exercises) {
                        mod.exercises.forEach(ex => {
                            html += `
                                <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                    <h3 style="color: #00ccff;">${ex.name}</h3>
                                    <p style="color: #888;">Muscle: ${ex.muscleGroup}</p>
                                    <div style="margin-top: 10px;">
                            `;
                            ex.workingSets.forEach((set, i) => {
                                html += `<p style="color: #aaa;">Set ${i+1}: ${set.weight} lbs √ó ${set.reps} reps @ RPE ${set.rpe || 'N/A'}</p>`;
                            });
                            html += `</div></div>`;
                        });
                    }
                    html += `<p style="color: #aaa; margin-top: 10px;">Feeling: ${mod.feeling} | Sleep: ${mod.sleep}hr | CNS: ${mod.cnsScore}</p>`;
                    
                } else if (type === 'bike') {
                    if (mod.intervals) {
                        html += `<p style="color: #00ccff; margin-bottom: 10px;">Protocol: ${mod.protocol}</p>`;
                        mod.intervals.forEach((int, i) => {
                            html += `<p style="color: #aaa;">Int ${i+1}: ${int.rpm} RPM √ó ${int.duration}s (rest ${int.rest}s) @ RPE ${int.rpe || 'N/A'}</p>`;
                        });
                        html += `<p style="color: #888; margin-top: 10px;">Peak RPM: ${mod.peakRPM} | Avg RPM: ${mod.avgRPM}</p>`;
                    }
                    html += `<p style="color: #aaa; margin-top: 10px;">Feeling: ${mod.feeling} | CNS: ${mod.cnsScore}</p>`;
                    
                } else if (type === 'track') {
                    html += `
                        <p style="color: #aaa;">Contacts: ${mod.contacts}</p>
                        <p style="color: #aaa;">Max Jumps: ${mod.maxJumps}</p>
                        <p style="color: #aaa;">Sprints: ${mod.sprints}</p>
                        <p style="color: #aaa;">Ground: ${mod.ground} | Energy: ${mod.energy}</p>
                        <p style="color: #aaa; margin-top: 10px;">CNS: ${mod.cnsScore}</p>
                    `;
                    
                } else if (type === 'bjj') {
                    html += `
                        <p style="color: #aaa;">Time: ${mod.time} min | Intensity: ${mod.intensity}</p>
                        <p style="color: #aaa;">Weight loss: ${mod.weightLoss} lbs</p>
                        <p style="color: #aaa; margin-top: 10px;">CNS: ${mod.cnsScore}</p>
                    `;
                    
                } else if (type === 'walking') {
                    html += `
                        <p style="color: #aaa;">Duration: ${mod.duration} min | Distance: ${mod.distance} miles</p>
                        <p style="color: #aaa;">Pace: ${mod.pace} min/mile | Terrain: ${mod.terrain}</p>
                        <p style="color: #aaa; margin-top: 10px;">CNS: ${mod.cnsScore}</p>
                    `;
                }
                
                // HR Analysis if available
                if (mod.hrAnalysis) {
                    const hr = mod.hrAnalysis;
                    html += `
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 12px; border-radius: 6px; margin-top: 10px; border: 1px solid #00ff88;">
                            <p style="color: #00ff88; font-weight: bold;">‚ù§Ô∏è HR ANALYSIS:</p>
                            <p style="color: #aaa;">Peak: ${hr.peakHR} bpm | Avg: ${hr.avgHR} bpm</p>
                            <p style="color: #aaa;">Z5: ${hr.timeInZone5}min | Z4: ${hr.timeInZone4}min | Z3: ${hr.timeInZone3}min | Z2: ${hr.timeInZone2}min</p>
                            <p style="color: #aaa;">Recovery: ${hr.recovery}</p>
                            ${hr.notes ? `<p style="color: #888; font-size: 13px; margin-top: 5px;">${hr.notes}</p>` : ''}
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            // Qualities
            if (dayData.qualities && Object.keys(dayData.qualities).length > 0) {
                html += `
                    <div class="info-box">
                        <h3 style="color: #00ccff;">TRAINING QUALITIES</h3>
                        ${Object.keys(dayData.qualities).filter(q => dayData.qualities[q] >= 15).map(q => 
                            `<p><strong>${q.charAt(0).toUpperCase() + q.slice(1)}:</strong> ${dayData.qualities[q]}%</p>`
                        ).join('')}
                    </div>
                `;
            }
            
            // Interference warnings
            if (dayData.interference && dayData.interference.length > 0) {
                html += `<div class="warning-box"><h3>‚ö†Ô∏è INTERFERENCE DETECTED</h3>`;
                dayData.interference.forEach(issue => {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <p><strong>${issue.message}</strong></p>
                            <p style="color: #ff6666;">Impact: ${issue.impact}</p>
                            <p style="color: #00ff88;">Fix: ${issue.fix}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `
                        <button onclick="openDay('${dateStr}', new Date('${date}'))" style="background: #00ccff; color: #000; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;">
                            ‚úèÔ∏è EDIT THIS WORKOUT
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
        }
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }
        
        // ========== DAY VIEW (HYBRID FORM) ==========
        let currentEditingDate = null;
        
        function openDay(dateStr, date) {
            currentEditingDate = dateStr;
            const dayData = trainingData[dateStr] || { modalities: {} };
            
            exerciseCounters = {};
            setCounters = {};
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <h3 style="color: #00ff88; margin-bottom: 15px;">SELECT TRAINING MODALITIES FOR TODAY:</h3>
                        
                        <div class="modality-checkboxes">
                            <div class="modality-checkbox ${dayData.modalities.chest ? 'checked' : ''}" onclick="toggleModality('chest')">
                                <input type="checkbox" id="check-chest" ${dayData.modalities.chest ? 'checked' : ''}>
                                <label for="check-chest">üí™ CHEST</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.back ? 'checked' : ''}" onclick="toggleModality('back')">
                                <input type="checkbox" id="check-back" ${dayData.modalities.back ? 'checked' : ''}>
                                <label for="check-back">üí™ BACK</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.legs ? 'checked' : ''}" onclick="toggleModality('legs')">
                                <input type="checkbox" id="check-legs" ${dayData.modalities.legs ? 'checked' : ''}>
                                <label for="check-legs">üí™ LEGS</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.track ? 'checked' : ''}" onclick="toggleModality('track')">
                                <input type="checkbox" id="check-track" ${dayData.modalities.track ? 'checked' : ''}>
                                <label for="check-track">üèÉ TRACK</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.bike ? 'checked' : ''}" onclick="toggleModality('bike')">
                                <input type="checkbox" id="check-bike" ${dayData.modalities.bike ? 'checked' : ''}>
                                <label for="check-bike">üö¥ BIKE</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.bjj ? 'checked' : ''}" onclick="toggleModality('bjj')">
                                <input type="checkbox" id="check-bjj" ${dayData.modalities.bjj ? 'checked' : ''}>
                                <label for="check-bjj">ü•ã BJJ</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.walking ? 'checked' : ''}" onclick="toggleModality('walking')">
                                <input type="checkbox" id="check-walking" ${dayData.modalities.walking ? 'checked' : ''}>
                                <label for="check-walking">üö∂ WALKING</label>
                            </div>
                        </div>
                        
                        <div id="form-chest" class="hidden modality-section"></div>
                        <div id="form-back" class="hidden modality-section"></div>
                        <div id="form-legs" class="hidden modality-section"></div>
                        <div id="form-track" class="hidden modality-section"></div>
                        <div id="form-bike" class="hidden modality-section"></div>
                        <div id="form-bjj" class="hidden modality-section"></div>
                        <div id="form-walking" class="hidden modality-section"></div>
                        
                        <button class="save-day-btn" onclick="saveDay('${dateStr}')">‚úì SAVE ALL TRAINING & ANALYZE</button>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
            
            Object.keys(dayData.modalities || {}).forEach(type => {
                if (dayData.modalities[type]) {
                    showModalityForm(type, dayData.modalities[type]);
                }
            });
        }
        
        function toggleModality(type) {
            const checkbox = document.getElementById('check-' + type);
            checkbox.checked = !checkbox.checked;
            
            const container = checkbox.parentElement;
            container.classList.toggle('checked');
            
            if (checkbox.checked) {
                showModalityForm(type);
            } else {
                document.getElementById('form-' + type).classList.add('hidden');
            }
        }
        
        function showModalityForm(type, data = null) {
            const form = document.getElementById('form-' + type);
            form.classList.remove('hidden');
            
            if (type === 'chest' || type === 'back' || type === 'legs') {
                form.innerHTML = generateWeightForm(type, data);
                if (!exerciseCounters[type]) exerciseCounters[type] = 0;
                if (data && data.exercises) {
                    // Load existing exercises
                } else {
                    addExercise(type);
                }
            } else if (type === 'track') {
                form.innerHTML = generateTrackForm(data);
            } else if (type === 'bike') {
                form.innerHTML = generateBikeForm(data);
                if (!setCounters['bike']) setCounters['bike'] = 0;
                // Add initial intervals
                addBikeInterval();
                addBikeInterval();
                addBikeInterval();
            } else if (type === 'bjj') {
                form.innerHTML = generateBJJForm(data);
            } else if (type === 'walking') {
                form.innerHTML = generateWalkingForm(data);
            }
        }
        
        // ========== WEIGHT FORM GENERATOR ==========
        function generateWeightForm(type, data) {
            return `
                <h2>üí™ ${type.toUpperCase()} TRAINING</h2>
                <div class="section-content">
                    <button class="rpe-btn" onclick="showRPEGuide()">‚ùì RPE REFERENCE GUIDE</button>
                    
                    <div id="${type}-exercises"></div>
                    
                    <button class="add-exercise-btn" onclick="addExercise('${type}')">+ ADD EXERCISE</button>
                    
                    <h3 style="color: #00ccff; margin-top: 30px; margin-bottom: 15px;">Session Details:</h3>
                    
                    <div class="question">
                        <label>Overall feeling:</label>
                        <select id="${type}-feeling">
                            <option value="">Choose...</option>
                            <option value="great">Great - Strong & energized</option>
                            <option value="good">Good - Felt solid</option>
                            <option value="tired">Tired - Low energy</option>
                            <option value="beat">Beat Up - Sore & exhausted</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Sleep last night (hours):</label>
                        <input type="number" id="${type}-sleep" step="0.5" placeholder="7.5" value="${data && data.sleep || ''}">
                    </div>
                    
                    <div class="upload-zone" id="${type}-upload" onclick="document.getElementById('${type}-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (optional)
                    </div>
                    <input type="file" id="${type}-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('${type}', event)">
                    <img id="${type}-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        function addExercise(type) {
            exerciseCounters[type]++;
            const exId = `${type}-ex${exerciseCounters[type]}`;
            setCounters[exId] = { warmup: 0, working: 0 };
            
            const html = `
                <div class="exercise-block" id="${exId}">
                    <input type="text" class="exercise-name" placeholder="Exercise name (e.g., Bench Press, Squat)" onblur="checkExerciseHistory('${exId}', this.value)">
                    
                    <div id="${exId}-history" class="hidden" style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #00ff88;">
                        <!-- Auto-progression suggestions appear here -->
                    </div>
                    
                    <select class="muscle-select">
                        <option value="">Select muscle group...</option>
                        <option value="chest">Chest (pecs, front delts)</option>
                        <option value="back">Back (lats, traps, rear delts)</option>
                        <option value="shoulders">Shoulders (delts)</option>
                        <option value="biceps">Biceps</option>
                        <option value="triceps">Triceps</option>
                        <option value="quads">Quads (front thighs)</option>
                        <option value="hamstrings">Hamstrings (back thighs)</option>
                        <option value="glutes">Glutes</option>
                        <option value="calves">Calves</option>
                        <option value="core">Core (abs, obliques)</option>
                    </select>
                    
                    <div class="set-label">WARM-UP SETS</div>
                    <div id="${exId}-warmup"></div>
                    <button class="add-btn" onclick="addSet('${exId}', 'warmup')">+ Add Warm-up</button>
                    
                    <div class="set-label">WORKING SETS</div>
                    <div id="${exId}-working"></div>
                    <button class="add-btn" onclick="addSet('${exId}', 'working')">+ Add Working Set</button>
                </div>
            `;
            
            document.getElementById(type + '-exercises').insertAdjacentHTML('beforeend', html);
            addSet(exId, 'warmup');
            addSet(exId, 'warmup');
            addSet(exId, 'working');
            addSet(exId, 'working');
            addSet(exId, 'working');
        }
        
        function checkExerciseHistory(exId, exerciseName) {
            if (!exerciseName || exerciseName.trim() === '') return;
            
            const historyDiv = document.getElementById(exId + '-history');
            const lastWorkout = getLastWorkout(exerciseName);
            
            if (!lastWorkout) {
                historyDiv.classList.add('hidden');
                return;
            }
            
            const progression = suggestProgression(exerciseName, lastWorkout.sets);
            if (!progression) return;
            
            let html = `
                <div style="color: #00ff88; font-weight: bold; margin-bottom: 10px;">
                    üìä LAST WORKOUT (${lastWorkout.date}):
                </div>
                <div style="color: #aaa; margin-bottom: 10px;">
                    Best Set: ${progression.lastBest.weight} lbs √ó ${progression.lastBest.reps} reps @ RPE ${progression.lastBest.rpe || 'N/A'}
                </div>
                <div style="color: #00ccff; font-weight: bold; margin-bottom: 8px;">
                    üí° PROGRESSION OPTIONS:
                </div>
            `;
            
            progression.suggestions.forEach((sug, i) => {
                html += `
                    <button onclick="applyProgression('${exId}', ${sug.weight}, ${sug.reps})" 
                            style="background: #2a2a2a; border: 1px solid #00ff88; color: white; padding: 8px 12px; border-radius: 6px; margin: 4px; cursor: pointer; font-size: 13px;">
                        ${sug.weight} lbs √ó ${sug.reps} reps - ${sug.desc}
                    </button>
                `;
            });
            
            historyDiv.innerHTML = html;
            historyDiv.classList.remove('hidden');
        }
        
        function applyProgression(exId, weight, reps) {
            // Auto-fill the first working set with suggested progression
            const workingDiv = document.getElementById(exId + '-working');
            const firstSet = workingDiv.querySelector('.set-row');
            if (firstSet) {
                firstSet.querySelector('.working-weight').value = weight;
                firstSet.querySelector('.working-reps').value = reps;
                alert(`‚úì Applied: ${weight} lbs √ó ${reps} reps to Set 1`);
            }
        }
        
        function addSet(exId, type) {
            setCounters[exId][type]++;
            const setId = `${exId}-${type}${setCounters[exId][type]}`;
            const html = `
                <div class="set-row" id="${setId}">
                    <input type="number" placeholder="Weight" class="${type}-weight">
                    <input type="number" placeholder="Reps" class="${type}-reps">
                    <input type="number" placeholder="RPE" class="${type}-rpe" step="0.5" ${type === 'warmup' ? 'style="display:none"' : ''}>
                    <button class="delete-btn" onclick="deleteSet('${setId}')">‚úï</button>
                </div>
            `;
            document.getElementById(`${exId}-${type}`).insertAdjacentHTML('beforeend', html);
        }
        
        function deleteSet(setId) {
            document.getElementById(setId).remove();
        }
        
        // ========== OTHER FORM GENERATORS ==========
        function generateTrackForm(data) {
            return `
                <h2>üèÉ TRACK / PLYOMETRICS</h2>
                <div class="section-content">
                    <div class="question">
                        <label>Total contacts (estimate all plyometric contacts):</label>
                        <input type="number" id="track-contacts" placeholder="300" value="${data && data.contacts || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Number of max effort jumps:</label>
                        <input type="number" id="track-max-jumps" placeholder="10" value="${data && data.maxJumps || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Number of sprints:</label>
                        <input type="number" id="track-sprints" placeholder="5" value="${data && data.sprints || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Ground feel:</label>
                        <select id="track-ground">
                            <option value="">Choose...</option>
                            <option value="bouncy">Bouncy - Reactive & springy</option>
                            <option value="normal">Normal - Average feel</option>
                            <option value="heavy">Heavy - Sluggish & flat</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Energy level:</label>
                        <select id="track-energy">
                            <option value="">Choose...</option>
                            <option value="high">High - Explosive power</option>
                            <option value="moderate">Moderate - Decent output</option>
                            <option value="low">Low - Struggling</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Achilles/calf status:</label>
                        <select id="track-achilles">
                            <option value="">Choose...</option>
                            <option value="fresh">Fresh - No issues</option>
                            <option value="tight">Tight - Some tension</option>
                            <option value="sore">Sore - Notable discomfort</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Sleep last night (hours):</label>
                        <input type="number" id="track-sleep" step="0.5" placeholder="7.5" value="${data && data.sleep || ''}">
                    </div>
                    
                    <div class="upload-zone" id="track-upload" onclick="document.getElementById('track-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (optional)
                    </div>
                    <input type="file" id="track-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('track', event)">
                    <img id="track-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        function generateBikeForm(data) {
            if (!setCounters['bike']) setCounters['bike'] = 0;
            
            return `
                <h2>üö¥ ASSAULT BIKE</h2>
                <div class="section-content">
                    <button class="rpe-btn" onclick="showRPEGuide()">‚ùì RPE REFERENCE GUIDE</button>
                    
                    <div class="question">
                        <label>Protocol:</label>
                        <select id="bike-protocol">
                            <option value="">Choose...</option>
                            <option value="peak-rpm">Peak RPM Sprints</option>
                            <option value="zone5">Zone 5 Intervals</option>
                            <option value="alternating">Alternating Pace</option>
                            <option value="steady">Steady State</option>
                        </select>
                    </div>
                    
                    <div class="set-label" style="margin-top: 25px;">INTERVALS / SETS</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 40px; gap: 8px; margin-bottom: 8px; color: #888; font-size: 13px; font-weight: bold;">
                        <div>RPM</div>
                        <div>Duration (sec)</div>
                        <div>Rest (sec)</div>
                        <div>RPE</div>
                        <div></div>
                    </div>
                    <div id="bike-intervals"></div>
                    <button class="add-btn" onclick="addBikeInterval()">+ Add Interval</button>
                    
                    <h3 style="color: #00ccff; margin-top: 30px; margin-bottom: 15px;">Session Details:</h3>
                    
                    <div class="question">
                        <label>Breathing quality:</label>
                        <select id="bike-breathing">
                            <option value="">Choose...</option>
                            <option value="strong">Strong - Controlled breathing</option>
                            <option value="moderate">Moderate - Some struggle</option>
                            <option value="labored">Labored - Very difficult</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Overall feeling:</label>
                        <select id="bike-feeling">
                            <option value="">Choose...</option>
                            <option value="great">Great</option>
                            <option value="good">Good</option>
                            <option value="tired">Tired</option>
                            <option value="beat">Beat up</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Sleep last night (hours):</label>
                        <input type="number" id="bike-sleep" step="0.5" placeholder="7.5" value="${data && data.sleep || ''}">
                    </div>
                    
                    <div class="upload-zone" id="bike-upload" onclick="document.getElementById('bike-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (HIGHLY RECOMMENDED)
                    </div>
                    <input type="file" id="bike-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('bike', event)">
                    <img id="bike-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        function addBikeInterval() {
            setCounters['bike']++;
            const intervalId = `bike-int${setCounters['bike']}`;
            
            const html = `
                <div class="set-row" id="${intervalId}" style="grid-template-columns: 1fr 1fr 1fr 1fr 40px; margin-bottom: 10px;">
                    <input type="number" placeholder="RPM" class="bike-rpm" style="font-weight: bold;">
                    <input type="number" placeholder="Duration (sec)" class="bike-duration">
                    <input type="number" placeholder="Rest (sec)" class="bike-rest">
                    <input type="number" placeholder="RPE" class="bike-rpe" step="0.5">
                    <button class="delete-btn" onclick="deleteBikeInterval('${intervalId}')">‚úï</button>
                </div>
            `;
            
            document.getElementById('bike-intervals').insertAdjacentHTML('beforeend', html);
        }
        
        function deleteBikeInterval(intervalId) {
            document.getElementById(intervalId).remove();
        }
        
        function generateBJJForm(data) {
            return `
                <h2>ü•ã JIU JITSU</h2>
                <div class="section-content">
                    <div class="question">
                        <label>Spar time (minutes):</label>
                        <input type="number" id="bjj-time" placeholder="45" value="${data && data.time || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Intensity:</label>
                        <select id="bjj-intensity">
                            <option value="">Choose...</option>
                            <option value="high">High - Hard rolling</option>
                            <option value="medium">Medium - Flow rolling</option>
                            <option value="light">Light - Technique only</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Weight before (lbs):</label>
                        <input type="number" id="bjj-weight-before" step="0.1" placeholder="180.0" value="${data && data.weightBefore || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Weight after (lbs):</label>
                        <input type="number" id="bjj-weight-after" step="0.1" placeholder="177.0" value="${data && data.weightAfter || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Overall feeling:</label>
                        <select id="bjj-feeling">
                            <option value="">Choose...</option>
                            <option value="great">Great</option>
                            <option value="good">Good</option>
                            <option value="tired">Tired</option>
                            <option value="beat">Beat up</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Sleep last night (hours):</label>
                        <input type="number" id="bjj-sleep" step="0.5" placeholder="7.5" value="${data && data.sleep || ''}">
                    </div>
                    
                    <div class="upload-zone" id="bjj-upload" onclick="document.getElementById('bjj-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (optional)
                    </div>
                    <input type="file" id="bjj-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('bjj', event)">
                    <img id="bjj-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        function generateWalkingForm(data) {
            return `
                <h2>üö∂ WALKING / RECOVERY</h2>
                <div class="section-content">
                    <p style="color: #888; margin-bottom: 20px;">Active recovery through walking with HR monitoring</p>
                    
                    <div class="question">
                        <label>Duration (minutes):</label>
                        <input type="number" id="walking-duration" placeholder="30" value="${data && data.duration || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Distance (miles):</label>
                        <input type="number" id="walking-distance" step="0.1" placeholder="2.5" value="${data && data.distance || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Average pace (min/mile):</label>
                        <input type="number" id="walking-pace" step="0.1" placeholder="12.0" value="${data && data.pace || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Terrain:</label>
                        <select id="walking-terrain">
                            <option value="">Choose...</option>
                            <option value="flat">Flat - Level ground</option>
                            <option value="hills">Hills - Moderate elevation</option>
                            <option value="steep">Steep - Significant incline</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Purpose:</label>
                        <select id="walking-purpose">
                            <option value="">Choose...</option>
                            <option value="recovery">Active Recovery</option>
                            <option value="zone2">Zone 2 Cardio</option>
                            <option value="general">General Activity</option>
                        </select>
                    </div>
                    
                    <div class="upload-zone" id="walking-upload" onclick="document.getElementById('walking-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (RECOMMENDED for Zone 2 tracking)
                    </div>
                    <input type="file" id="walking-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('walking', event)">
                    <img id="walking-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        // ========== HR UPLOAD & AI ANALYSIS ==========
        let hrData = {};
        
        async function handleHRUpload(type, event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById(type + '-hr-preview');
            const uploadZone = document.getElementById(type + '-upload');
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                uploadZone.classList.add('has-file');
                uploadZone.innerHTML = 'üìä HR Data Uploaded - Analyzing with AI...';
            };
            reader.readAsDataURL(file);
            
            // AI Analysis
            try {
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(",")[1];
                        resolve(base64);
                    };
                    reader.onerror = () => reject(new Error("Failed to read file"));
                    reader.readAsDataURL(file);
                });
                
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "image",
                                        source: {
                                            type: "base64",
                                            media_type: "image/jpeg",
                                            data: base64Data,
                                        }
                                    },
                                    {
                                        type: "text",
                                        text: `Analyze this Polar heart rate monitor graph. Extract the following data and respond ONLY with valid JSON (no markdown, no other text):

{
  "peakHR": number,
  "avgHR": number,
  "timeInZone5": number (minutes in 90-100% max HR),
  "timeInZone4": number (minutes in 80-90% max HR),
  "timeInZone3": number (minutes in 70-80% max HR),
  "timeInZone2": number (minutes in 60-70% max HR),
  "recovery": "good" | "moderate" | "poor",
  "notes": "brief analysis"
}

DO NOT include any text outside the JSON object. Do not use markdown code blocks.`
                                    }
                                ]
                            }
                        ]
                    })
                });
                
                const data = await response.json();
                let responseText = data.content[0].text;
                
                // Strip any markdown
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                
                const hrAnalysis = JSON.parse(responseText);
                hrData[type] = hrAnalysis;
                
                // Display analysis
                uploadZone.innerHTML = `‚úì HR Analysis Complete
                    <br><span style="font-size: 12px; color: #00ff88;">
                    Peak: ${hrAnalysis.peakHR} bpm | Avg: ${hrAnalysis.avgHR} bpm | Recovery: ${hrAnalysis.recovery}
                    <br>Z5: ${hrAnalysis.timeInZone5}min | Z4: ${hrAnalysis.timeInZone4}min | Z3: ${hrAnalysis.timeInZone3}min
                    </span>`;
            } catch (error) {
                console.error("HR Analysis Error:", error);
                uploadZone.innerHTML = '‚ö†Ô∏è Could not analyze HR data - uploaded but analysis failed';
            }
        }
        
        // ========== RPE GUIDE ==========
        function showRPEGuide() {
            const html = `
                <div class="rpe-modal">
                    <div class="rpe-content">
                        <button class="close-btn" onclick="closeRPEGuide()">‚úï Close</button>
                        <h2 style="color: #00ff88; margin-bottom: 20px; clear: both;">RPE REFERENCE GUIDE</h2>
                        <p style="color: #aaa; margin-bottom: 20px;">RPE (Rate of Perceived Exertion) = Reps In Reserve (RIR)</p>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">10</div>
                            <div class="rpe-rir">0 RIR</div>
                            <div class="rpe-desc">Absolute failure - could NOT do another rep</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">9.5</div>
                            <div class="rpe-rir">0-1 RIR</div>
                            <div class="rpe-desc">Maybe 1 more rep - almost certain failure</div>
                        </div>
                        
                        <div class="rpe-row" style="border: 2px solid #ff6b35;">
                            <div class="rpe-number">9</div>
                            <div class="rpe-rir">1 RIR</div>
                            <div class="rpe-desc"><strong>ALMOST FAILURE</strong> - Definitely 1 rep left, not 2</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">8.5</div>
                            <div class="rpe-rir">1-2 RIR</div>
                            <div class="rpe-desc">1 rep for sure, maybe 2</div>
                        </div>
                        
                        <div class="rpe-row" style="border: 2px solid #00ff88;">
                            <div class="rpe-number">8</div>
                            <div class="rpe-rir">2 RIR</div>
                            <div class="rpe-desc"><strong>OPTIMAL FOR HYPERTROPHY</strong> - Solid 2 reps left</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">7.5</div>
                            <div class="rpe-rir">2-3 RIR</div>
                            <div class="rpe-desc">2 reps for sure, maybe 3</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">7</div>
                            <div class="rpe-rir">3 RIR</div>
                            <div class="rpe-desc">Moderate difficulty - 3 reps left</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">6</div>
                            <div class="rpe-rir">4 RIR</div>
                            <div class="rpe-desc">Bar speed still fast - 4+ reps left</div>
                        </div>
                        
                        <p style="color: #666; margin-top: 20px; font-size: 13px; text-align: center;">
                            RIR = Reps In Reserve (how many more reps you could do)
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('rpe-modal').innerHTML = html;
            document.getElementById('rpe-modal').classList.remove('hidden');
        }
        
        function closeRPEGuide() {
            document.getElementById('rpe-modal').classList.add('hidden');
        }
        
        function closeModal() {
            document.getElementById('day-modal').classList.add('hidden');
            document.getElementById('weekly-modal').classList.add('hidden');
            hrData = {}; // Clear HR data
        }
        
        function showHelp() {
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üìñ ELITE ATHLETE TRACKER - USER GUIDE</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ff88;">üéØ CORE FEATURES</h3>
                            <p><strong>Hybrid Training Days:</strong> Log multiple modalities on the same day (Chest + Legs + Bike + BJJ, etc.)</p>
                            <p><strong>7 Modalities:</strong> Chest, Back, Legs, Track/Plyos, Assault Bike, BJJ, Walking</p>
                            <p><strong>AI HR Analysis:</strong> Upload Polar screenshots for automatic HR zone extraction</p>
                            <p><strong>Elite Metrics:</strong> TSS, A:C Ratio, Fitness-Fatigue Model, Monotony, Strain</p>
                            <p><strong>Auto-Progression:</strong> System suggests next weights based on your history</p>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">üìÖ CALENDAR USAGE</h3>
                            <p><strong>Empty Day:</strong> Click to log new workout</p>
                            <p><strong>Completed Day:</strong> Click to view/edit workout</p>
                            <p><strong>Right-Click or Ctrl+Click:</strong> View detailed historical analysis</p>
                            <p><strong>CNS Indicators:</strong> Green (low), Yellow (moderate), Red (high CNS load)</p>
                            <p><strong>Badges:</strong> Show which modalities you completed</p>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #ff6b35;">üí™ LOGGING WORKOUTS</h3>
                            <p><strong>Select Modalities:</strong> Check all training you did that day</p>
                            <p><strong>Exercises:</strong> Type name ‚Üí system shows last workout + progression suggestions</p>
                            <p><strong>RPE:</strong> Use 6-10 scale (click "RPE GUIDE" for reference)</p>
                            <p><strong>Bike Intervals:</strong> Log RPM, duration, rest, and RPE per interval</p>
                            <p><strong>HR Upload:</strong> Upload Polar screenshot ‚Üí AI extracts zones automatically</p>
                            <p><strong>Save:</strong> One button saves ALL modalities with full analysis</p>
                        </div>
                        
                        <div class="success-box">
                            <h3 style="color: #00ff88;">üß† AUTO-PROGRESSION</h3>
                            <p><strong>How it Works:</strong> Type exercise name ‚Üí system shows your last workout</p>
                            <p><strong>Suggestions:</strong> Click button to auto-fill suggested weight/reps</p>
                            <p><strong>Strategies:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Volume: Same weight, +1 rep</li>
                                <li>Intensity: +2.5-5 lbs, same reps</li>
                                <li>Deload: -10% if last RPE was ‚â•9.5</li>
                            </ul>
                        </div>
                        
                        <div class="warning-box">
                            <h3>‚ö†Ô∏è INTERFERENCE DETECTION</h3>
                            <p><strong>Before Save:</strong> System warns if you're combining problematic modalities</p>
                            <p><strong>Critical Combos:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Legs + Track = Type II fiber overload</li>
                                <li>4+ modalities = Extreme CNS stress</li>
                            </ul>
                            <p><strong>After Save:</strong> Full interference analysis with recovery recommendations</p>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">üìä WEEKLY ANALYSIS</h3>
                            <p><strong>Load Metrics:</strong> Volume, CNS, TSS, A:C Ratio, Monotony, Strain</p>
                            <p><strong>Fitness-Fatigue Model:</strong> Shows if you're building fitness or accumulating fatigue</p>
                            <p><strong>Recovery Status:</strong> Excellent/Good/Moderate/Poor based on CNS trends</p>
                            <p><strong>Next Week Forecast:</strong> AI predicts your readiness and gives recommendations</p>
                            <p><strong>Injury Warnings:</strong> Alerts when A:C ratio >1.3 (injury risk zone)</p>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #8a2be2;">üî¨ UNDERSTANDING METRICS</h3>
                            <p><strong>CNS Score (0-100):</strong> Neural system stress. <60=low, 60-75=moderate, >75=high</p>
                            <p><strong>TSS (Training Stress Score):</strong> Total training load combining duration, intensity, volume</p>
                            <p><strong>A:C Ratio:</strong> This week vs 4-week average. 0.8-1.3 = optimal, >1.5 = injury risk</p>
                            <p><strong>Monotony:</strong> Training variation. High monotony + high strain = overtraining</p>
                            <p><strong>Fitness:</strong> Adaptations from training (builds slowly, decays slowly)</p>
                            <p><strong>Fatigue:</strong> Accumulated stress (builds fast, dissipates fast with rest)</p>
                            <p><strong>Performance:</strong> Fitness - Fatigue. Positive = ready for PRs. Negative = need recovery</p>
                        </div>
                        
                        <div class="success-box">
                            <h3 style="color: #00ff88;">üí° PRO TIPS</h3>
                            <ul style="margin-left: 20px;">
                                <li>Always upload HR data for cardio (Bike, Walking, Track)</li>
                                <li>Track sleep every session - major CNS factor</li>
                                <li>When A:C ratio >1.3, immediately reduce volume</li>
                                <li>Performance <-15 = mandatory deload week</li>
                                <li>Use auto-progression suggestions to stay consistent</li>
                                <li>Right-click past days to compare progress</li>
                                <li>Walking is crucial for active recovery - track it!</li>
                            </ul>
                        </div>
                        
                        <div style="background: #0a0a0a; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px;">
                            <p style="color: #666; font-size: 12px;">
                                All data saved locally in your browser ‚Ä¢ No account needed ‚Ä¢ Export coming soon
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('weekly-modal').innerHTML = html;
            document.getElementById('weekly-modal').classList.remove('hidden');
        }
        
        // ========== SAVE DAY ==========
        async function saveDay(dateStr) {
            const data = {
                modalities: {},
                totalCNS: 0,
                totalVolume: 0,
                tss: 0,
                qualities: {}
            };
            
            // Collect from each checked modality
            const modalityTypes = ['chest', 'back', 'legs', 'track', 'bike', 'bjj', 'walking'];
            
            for (const type of modalityTypes) {
                const checkbox = document.getElementById('check-' + type);
                if (checkbox && checkbox.checked) {
                    const modalityData = await collectModalityData(type);
                    if (modalityData) {
                        data.modalities[type] = modalityData;
                        data.modalities[type].completed = true;
                    }
                }
            }
            
            if (Object.keys(data.modalities).length === 0) {
                alert('Please select and complete at least one training modality!');
                return;
            }
            
            // PROACTIVE INTERFERENCE CHECK - BEFORE SAVING
            const earlyInterference = detectInterferenceEarly(data.modalities);
            if (earlyInterference.critical.length > 0) {
                const proceed = confirm(
                    '‚ö†Ô∏è CRITICAL INTERFERENCE DETECTED:\n\n' +
                    earlyInterference.critical.map(i => `‚Ä¢ ${i.message}\n  Impact: ${i.impact}\n  Fix: ${i.fix}`).join('\n\n') +
                    '\n\nDo you want to save anyway?'
                );
                if (!proceed) return;
            }
            
            // Calculate combined metrics
            Object.keys(data.modalities).forEach(type => {
                const mod = data.modalities[type];
                data.totalCNS += mod.cnsScore || 0;
                data.totalVolume += mod.volume || 0;
                data.tss += mod.tss || 0;
            });
            
            // Quality analysis
            data.qualities = analyzeQualities(data.modalities);
            
            // Interference detection (full)
            data.interference = detectInterference(data.modalities, data.qualities);
            
            // Store exercise history for progression
            Object.keys(data.modalities).forEach(type => {
                if ((type === 'chest' || type === 'back' || type === 'legs') && data.modalities[type].exercises) {
                    updateExerciseHistory(dateStr, data.modalities[type].exercises);
                }
            });
            
            trainingData[dateStr] = data;
            historicalTSS.push({ date: dateStr, tss: data.tss });
            if (historicalTSS.length > 28) historicalTSS.shift();
            
            saveData();
            
            // Show results
            displayDayAnalysis(dateStr, data);
        }
        
        // Early interference detection (before save)
        function detectInterferenceEarly(modalities) {
            const critical = [];
            const warnings = [];
            const types = Object.keys(modalities);
            
            // Critical combinations
            if (types.includes('legs') && types.includes('track')) {
                critical.push({
                    message: 'Legs + Track same day = Type II fiber overload',
                    impact: 'Power output compromised 15-20%, injury risk elevated',
                    fix: 'Separate by 48hr minimum OR do track BEFORE legs'
                });
            }
            
            if (types.length >= 4 && !types.includes('walking')) {
                critical.push({
                    message: `${types.length} HIGH-INTENSITY modalities in one day`,
                    impact: 'Extreme CNS overload, recovery compromised',
                    fix: 'Split across 2 days or reduce volume by 30%'
                });
            }
            
            // Warnings
            if (types.includes('bjj') && types.includes('back')) {
                warnings.push({
                    message: 'BJJ + Back = Grip fatigue compounding',
                    impact: 'Pulling strength reduced 10-15%',
                    fix: 'Use straps or separate modalities'
                });
            }
            
            if (types.includes('chest') && types.includes('bjj')) {
                warnings.push({
                    message: 'Chest + BJJ = Pushing fatigue overlap',
                    impact: 'Both use pecs/triceps heavily',
                    fix: 'Do chest AFTER BJJ if possible'
                });
            }
            
            return { critical, warnings };
        }
        
        async function collectModalityData(type) {
            const data = { type };
            
            if (type === 'chest' || type === 'back' || type === 'legs') {
                const exercises = [];
                const exerciseBlocks = document.querySelectorAll(`#${type}-exercises .exercise-block`);
                
                exerciseBlocks.forEach(block => {
                    const name = block.querySelector('.exercise-name').value;
                    const muscleGroup = block.querySelector('.muscle-select').value;
                    if (!name || !muscleGroup) return;
                    
                    const workingSets = [];
                    const workingWeights = block.querySelectorAll('.working-weight');
                    workingWeights.forEach((w, i) => {
                        const weight = parseFloat(w.value) || 0;
                        const reps = parseInt(block.querySelectorAll('.working-reps')[i].value) || 0;
                        const rpe = parseFloat(block.querySelectorAll('.working-rpe')[i].value) || 0;
                        if (weight > 0 && reps > 0) {
                            workingSets.push({ weight, reps, rpe });
                        }
                    });
                    
                    if (workingSets.length > 0) {
                        exercises.push({ name, muscleGroup, workingSets });
                    }
                });
                
                if (exercises.length === 0) return null;
                
                data.exercises = exercises;
                data.feeling = document.getElementById(type + '-feeling')?.value || '';
                data.sleep = parseFloat(document.getElementById(type + '-sleep')?.value) || 0;
                data.hrAnalysis = hrData[type] || null;
                
                // Calculate metrics
                const metrics = calculateWeightMetrics(data);
                Object.assign(data, metrics);
                
            } else if (type === 'track') {
                data.contacts = parseInt(document.getElementById('track-contacts')?.value) || 0;
                data.maxJumps = parseInt(document.getElementById('track-max-jumps')?.value) || 0;
                data.sprints = parseInt(document.getElementById('track-sprints')?.value) || 0;
                data.ground = document.getElementById('track-ground')?.value || '';
                data.energy = document.getElementById('track-energy')?.value || '';
                data.achilles = document.getElementById('track-achilles')?.value || '';
                data.sleep = parseFloat(document.getElementById('track-sleep')?.value) || 0;
                data.hrAnalysis = hrData[type] || null;
                
                const metrics = calculateTrackMetrics(data);
                Object.assign(data, metrics);
                
            } else if (type === 'bike') {
                data.protocol = document.getElementById('bike-protocol')?.value || '';
                
                // Collect intervals
                const intervals = [];
                const rpmInputs = document.querySelectorAll('.bike-rpm');
                rpmInputs.forEach((input, i) => {
                    const rpm = parseInt(input.value) || 0;
                    const duration = parseInt(document.querySelectorAll('.bike-duration')[i].value) || 0;
                    const rest = parseInt(document.querySelectorAll('.bike-rest')[i].value) || 0;
                    const rpe = parseFloat(document.querySelectorAll('.bike-rpe')[i].value) || 0;
                    
                    if (rpm > 0 && duration > 0) {
                        intervals.push({ rpm, duration, rest, rpe });
                    }
                });
                
                if (intervals.length === 0) return null;
                
                data.intervals = intervals;
                data.breathing = document.getElementById('bike-breathing')?.value || '';
                data.feeling = document.getElementById('bike-feeling')?.value || '';
                data.sleep = parseFloat(document.getElementById('bike-sleep')?.value) || 0;
                data.hrAnalysis = hrData[type] || null;
                
                const metrics = calculateBikeMetrics(data);
                Object.assign(data, metrics);
                
            } else if (type === 'bjj') {
                data.time = parseInt(document.getElementById('bjj-time')?.value) || 0;
                data.intensity = document.getElementById('bjj-intensity')?.value || '';
                data.weightBefore = parseFloat(document.getElementById('bjj-weight-before')?.value) || 0;
                data.weightAfter = parseFloat(document.getElementById('bjj-weight-after')?.value) || 0;
                data.weightLoss = (data.weightBefore - data.weightAfter).toFixed(1);
                data.feeling = document.getElementById('bjj-feeling')?.value || '';
                data.sleep = parseFloat(document.getElementById('bjj-sleep')?.value) || 0;
                data.hrAnalysis = hrData[type] || null;
                
                const metrics = calculateBJJMetrics(data);
                Object.assign(data, metrics);
                
            } else if (type === 'walking') {
                data.duration = parseInt(document.getElementById('walking-duration')?.value) || 0;
                data.distance = parseFloat(document.getElementById('walking-distance')?.value) || 0;
                data.pace = parseFloat(document.getElementById('walking-pace')?.value) || 0;
                data.terrain = document.getElementById('walking-terrain')?.value || '';
                data.purpose = document.getElementById('walking-purpose')?.value || '';
                data.hrAnalysis = hrData[type] || null;
                
                const metrics = calculateWalkingMetrics(data);
                Object.assign(data, metrics);
            }
            
            return data;
        }
        
        // ========== METRICS CALCULATIONS ==========
        function calculateWeightMetrics(data) {
            let cnsScore = 40;
            let totalVolume = 0;
            let avgRPE = 0;
            let rpeCount = 0;
            
            data.exercises.forEach(ex => {
                ex.workingSets.forEach(set => {
                    totalVolume += set.weight * set.reps;
                    if (set.rpe) {
                        avgRPE += set.rpe;
                        rpeCount++;
                    }
                });
            });
            
            avgRPE = rpeCount > 0 ? avgRPE / rpeCount : 0;
            
            // CNS scoring
            if (data.feeling === 'beat') cnsScore += 20;
            if (data.feeling === 'tired') cnsScore += 12;
            if (data.feeling === 'great') cnsScore -= 10;
            
            if (avgRPE >= 9) cnsScore += 15;
            if (avgRPE >= 8.5) cnsScore += 10;
            if (avgRPE <= 7) cnsScore -= 8;
            
            if (data.sleep < 6.5) cnsScore += 15;
            if (data.sleep >= 8) cnsScore -= 8;
            
            // HR integration
            if (data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.avgHR >= 160) cnsScore += 12;
                else if (hr.avgHR >= 150) cnsScore += 8;
                
                if (hr.recovery === 'poor') cnsScore += 10;
                else if (hr.recovery === 'good') cnsScore -= 5;
                
                if (hr.timeInZone5 > 5) cnsScore += 8;
            }
            
            // TSS calculation
            const duration = 60; // Assume 60 min
            const intensity = avgRPE / 10;
            const tss = duration * intensity * 100;
            
            return {
                cnsScore: Math.max(0, Math.min(100, cnsScore)),
                volume: totalVolume,
                avgRPE: avgRPE.toFixed(1),
                tss: Math.round(tss)
            };
        }
        
        function calculateTrackMetrics(data) {
            let cnsScore = 35;
            
            if (data.ground === 'heavy') cnsScore += 25;
            if (data.energy === 'low') cnsScore += 18;
            if (data.achilles === 'sore') cnsScore += 25;
            if (data.contacts > 350) cnsScore += 15;
            if (data.maxJumps > 10) cnsScore += data.maxJumps * 2;
            if (data.sleep < 7) cnsScore += 12;
            
            if (data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.avgHR >= 170) cnsScore += 10;
                if (hr.timeInZone5 > 10) cnsScore += 12;
            }
            
            const tss = 60 + (data.contacts * 0.15) + (data.maxJumps * 2);
            
            return {
                cnsScore: Math.max(0, Math.min(100, cnsScore)),
                volume: 0,
                tss: Math.round(tss)
            };
        }
        
        function calculateBikeMetrics(data) {
            let cnsScore = 45;
            
            // Calculate from intervals
            let totalTime = 0;
            let avgRPM = 0;
            let peakRPM = 0;
            let avgRPE = 0;
            let rpeCount = 0;
            
            if (data.intervals && data.intervals.length > 0) {
                data.intervals.forEach(int => {
                    totalTime += int.duration / 60; // Convert to minutes
                    avgRPM += int.rpm;
                    if (int.rpm > peakRPM) peakRPM = int.rpm;
                    if (int.rpe) {
                        avgRPE += int.rpe;
                        rpeCount++;
                    }
                });
                avgRPM = avgRPM / data.intervals.length;
                if (rpeCount > 0) avgRPE = avgRPE / rpeCount;
            }
            
            // CNS based on RPM and RPE
            if (peakRPM >= 130) cnsScore += 15;
            else if (peakRPM >= 120) cnsScore += 10;
            
            if (avgRPE >= 9) cnsScore += 12;
            else if (avgRPE >= 8) cnsScore += 8;
            
            if (data.breathing === 'labored') cnsScore += 20;
            else if (data.breathing === 'moderate') cnsScore += 10;
            
            if (data.feeling === 'beat') cnsScore += 18;
            else if (data.feeling === 'tired') cnsScore += 10;
            
            if (data.sleep < 7) cnsScore += 10;
            
            if (data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.avgHR >= 170) cnsScore += 12;
                if (hr.timeInZone5 > 15) cnsScore += 15;
                if (hr.recovery === 'poor') cnsScore += 8;
            }
            
            // TSS calculation
            const tss = totalTime * 2 + (data.intervals.length * 5) + (avgRPE * 8);
            
            return {
                cnsScore: Math.max(0, Math.min(100, cnsScore)),
                volume: 0,
                tss: Math.round(tss),
                peakRPM: peakRPM,
                avgRPM: Math.round(avgRPM),
                totalTime: totalTime.toFixed(1)
            };
        }
        
        function calculateBJJMetrics(data) {
            let cnsScore = 40;
            const sweat = parseFloat(data.weightLoss) || 0;
            
            if (sweat >= 4) cnsScore += 20;
            else if (sweat >= 3) cnsScore += 10;
            
            if (data.intensity === 'high') cnsScore += 15;
            if (data.feeling === 'beat') cnsScore += 20;
            if (data.feeling === 'tired') cnsScore += 12;
            if (data.sleep < 7) cnsScore += 10;
            
            if (data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.avgHR >= 160) cnsScore += 10;
                if (hr.timeInZone5 > 20) cnsScore += 12;
            }
            
            const tss = data.time * 1.5 + (data.intensity === 'high' ? 30 : 0);
            
            return {
                cnsScore: Math.max(0, Math.min(100, cnsScore)),
                volume: 0,
                tss: Math.round(tss)
            };
        }
        
        function calculateWalkingMetrics(data) {
            let cnsScore = 10; // Very low CNS stress
            
            if (data.terrain === 'steep') cnsScore += 15;
            else if (data.terrain === 'hills') cnsScore += 8;
            
            if (data.purpose === 'zone2' && data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.timeInZone3 > hr.timeInZone2) {
                    cnsScore += 10; // Went too hard for recovery
                }
            }
            
            const tss = data.duration * 0.5; // Low stress
            
            return {
                cnsScore: Math.max(0, Math.min(100, cnsScore)),
                volume: 0,
                tss: Math.round(tss)
            };
        }
        
        // ========== QUALITY ANALYSIS ==========
        function analyzeQualities(modalities) {
            const qualities = {
                strength: 0,
                hypertrophy: 0,
                power: 0,
                speed: 0,
                endurance: 0
            };
            
            Object.keys(modalities).forEach(type => {
                const mod = modalities[type];
                
                if (type === 'chest' || type === 'back' || type === 'legs') {
                    if (mod.exercises) {
                        mod.exercises.forEach(ex => {
                            ex.workingSets.forEach(set => {
                                if (set.reps <= 5) {
                                    qualities.strength += set.reps * (set.rpe || 8);
                                } else if (set.reps <= 8) {
                                    qualities.strength += set.reps * 0.6 * (set.rpe || 8);
                                    qualities.hypertrophy += set.reps * 0.4 * (set.rpe || 8);
                                } else {
                                    qualities.hypertrophy += set.reps * (set.rpe || 8);
                                }
                            });
                        });
                    }
                } else if (type === 'track') {
                    qualities.power = mod.contacts * 0.8;
                    qualities.power += (mod.maxJumps || 0) * 20;
                    qualities.speed = (mod.sprints || 0) * 25;
                } else if (type === 'bike') {
                    qualities.endurance = 80;
                    if (mod.protocol === 'zone5' || mod.protocol === 'peak-rpm') {
                        qualities.power = 40;
                    }
                } else if (type === 'bjj') {
                    qualities.endurance = 50;
                    if (mod.intensity === 'high') {
                        qualities.power = 30;
                        qualities.strength = 20;
                    }
                } else if (type === 'walking') {
                    qualities.endurance = 30; // Low intensity recovery
                }
            });
            
            // Normalize
            const total = Object.values(qualities).reduce((a, b) => a + b, 0);
            if (total > 0) {
                Object.keys(qualities).forEach(q => {
                    qualities[q] = Math.round((qualities[q] / total) * 100);
                });
            }
            
            return qualities;
        }
        
        function detectInterference(modalities, qualities) {
            const issues = [];
            const types = Object.keys(modalities);
            
            // Check for problematic combinations
            if (types.includes('legs') && types.includes('track')) {
                issues.push({
                    severity: 'critical',
                    message: 'Legs + Track same day = Type II fiber overload',
                    impact: 'Power output compromised 15-20%, injury risk elevated',
                    fix: 'Separate by 48hr minimum'
                });
            }
            
            if (types.includes('bjj') && types.includes('back')) {
                issues.push({
                    severity: 'moderate',
                    message: 'BJJ + Back = Grip fatigue compounding',
                    impact: 'Pulling strength reduced 10-15%',
                    fix: 'Use straps or separate modalities'
                });
            }
            
            if (types.length >= 4) {
                issues.push({
                    severity: 'high',
                    message: `${types.length} modalities in one day = Extreme volume`,
                    impact: 'CNS overload, recovery compromised',
                    fix: 'Consider splitting across 2 days or reducing volume'
                });
            }
            
            return issues;
        }
        
        // ========== DAY ANALYSIS DISPLAY ==========
        function displayDayAnalysis(dateStr, data) {
            closeModal();
            renderCalendar();
            
            const modalityList = Object.keys(data.modalities).map(t => t.toUpperCase()).join(', ');
            
            let html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">‚úì Training Saved!</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="success-box">
                            <h3 style="color: #00ff88;">TRAINING COMPLETE: ${dateStr}</h3>
                            <p><strong>Modalities:</strong> ${modalityList}</p>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value">${data.totalCNS}</div>
                                <div class="metric-label">Total CNS Load</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.totalVolume.toLocaleString()}</div>
                                <div class="metric-label">Volume (lbs)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.tss}</div>
                                <div class="metric-label">Training Stress Score</div>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">TRAINING QUALITIES</h3>
                            ${Object.keys(data.qualities).filter(q => data.qualities[q] >= 20).map(q => 
                                `<p><strong>${q.charAt(0).toUpperCase() + q.slice(1)}:</strong> ${data.qualities[q]}%</p>`
                            ).join('')}
                        </div>
            `;
            
            if (data.interference && data.interference.length > 0) {
                html += `<div class="warning-box"><h3>‚ö†Ô∏è INTERFERENCE DETECTED</h3>`;
                data.interference.forEach(issue => {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <p><strong>${issue.message}</strong></p>
                            <p style="color: #ff6666;">Impact: ${issue.impact}</p>
                            <p style="color: #00ff88;">Fix: ${issue.fix}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `</div></div>`;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
        }
        
        // ========== WEEKLY ANALYSIS ==========
        function showWeeklyAnalysis() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 6);
            
            let totalCNS = 0;
            let totalVolume = 0;
            let totalTSS = 0;
            let days = 0;
            const dailyCNS = [];
            const dailyTSS = [];
            const workoutDates = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const dayData = trainingData[dateStr];
                
                if (dayData && dayData.modalities && Object.keys(dayData.modalities).length > 0) {
                    days++;
                    totalCNS += dayData.totalCNS || 0;
                    totalVolume += dayData.totalVolume || 0;
                    totalTSS += dayData.tss || 0;
                    dailyCNS.push(dayData.totalCNS || 0);
                    dailyTSS.push(dayData.tss || 0);
                    workoutDates.push(dateStr);
                }
            }
            
            const avgCNS = days > 0 ? Math.round(totalCNS / days) : 0;
            const avgTSS = days > 0 ? Math.round(totalTSS / days) : 0;
            
            // Monotony
            const mean = avgCNS;
            const variance = dailyCNS.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (dailyCNS.length || 1);
            const stdDev = Math.sqrt(variance);
            const monotony = stdDev > 0 ? (mean / stdDev).toFixed(2) : 0;
            
            // Strain
            const strain = Math.round(totalCNS * parseFloat(monotony));
            
            // A:C Ratio
            const last28Days = historicalTSS.slice(-28);
            let acRatio = '‚Äî';
            let acWarning = false;
            if (last28Days.length >= 14) {
                const chronicTSS = last28Days.reduce((a, b) => a + b.tss, 0) / last28Days.length;
                if (chronicTSS > 0) {
                    acRatio = (totalTSS / (chronicTSS * 7)).toFixed(2);
                    if (parseFloat(acRatio) > 1.3) acWarning = true;
                }
            }
            
            // Fitness-Fatigue Model
            const fitnessFatigue = calculateFitnessFatigue(historicalTSS);
            
            // Recovery Status
            const recoveryStatus = assessRecoveryStatus(dailyCNS, days);
            
            // Performance Prediction
            const performancePrediction = predictPerformance(fitnessFatigue, acRatio, recoveryStatus);
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üìä WEEKLY ANALYSIS</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <p style="color: #888; margin-bottom: 30px;">${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()} (${days} training days)</p>
                        
                        <h3 style="color: #00ff88; margin-bottom: 15px;">LOAD METRICS:</h3>
                        
                        <div class="metrics-grid">
                            <div class="metric-card" style="border-left-color: #00ff88;">
                                <div class="metric-value">${totalVolume.toLocaleString()}</div>
                                <div class="metric-label">Total Volume (lbs)</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #00ccff;">
                                <div class="metric-value">${avgCNS}</div>
                                <div class="metric-label">Avg Daily CNS</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #ffaa00;">
                                <div class="metric-value">${totalTSS}</div>
                                <div class="metric-label">Weekly TSS</div>
                            </div>
                            <div class="metric-card" style="border-left-color: ${acWarning ? '#ff4444' : '#ff6b35'};">
                                <div class="metric-value" style="color: ${acWarning ? '#ff4444' : '#00ff88'};">${acRatio}</div>
                                <div class="metric-label">Acute:Chronic Ratio</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #8a2be2;">
                                <div class="metric-value">${monotony}</div>
                                <div class="metric-label">Monotony Index</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #ff69b4;">
                                <div class="metric-value">${strain}</div>
                                <div class="metric-label">Strain Index</div>
                            </div>
                        </div>
                        
                        <h3 style="color: #00ff88; margin: 30px 0 15px 0;">FITNESS-FATIGUE MODEL:</h3>
                        
                        <div class="metrics-grid">
                            <div class="metric-card" style="border-left-color: #00ff88;">
                                <div class="metric-value">${fitnessFatigue.fitness}</div>
                                <div class="metric-label">Fitness ${fitnessFatigue.fitnessChange > 0 ? '‚Üë' : '‚Üì'}</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #ff6b35;">
                                <div class="metric-value">${fitnessFatigue.fatigue}</div>
                                <div class="metric-label">Fatigue ${fitnessFatigue.fatigueChange > 0 ? '‚Üë' : '‚Üì'}</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #00ccff;">
                                <div class="metric-value" style="color: ${fitnessFatigue.performance > 0 ? '#00ff88' : '#ff4444'};">${fitnessFatigue.performance > 0 ? '+' : ''}${fitnessFatigue.performance}</div>
                                <div class="metric-label">Performance</div>
                            </div>
                            <div class="metric-card" style="border-left-color: ${recoveryStatus.color};">
                                <div class="metric-value" style="color: ${recoveryStatus.color}; font-size: 20px;">${recoveryStatus.status}</div>
                                <div class="metric-label">Recovery Status</div>
                            </div>
                        </div>
                        
                        ${performancePrediction.html}
                        
                        ${acWarning ? `
                            <div class="warning-box">
                                <h3>‚ö†Ô∏è INJURY RISK WARNING</h3>
                                <p><strong>Acute:Chronic ratio: ${acRatio}</strong> (optimal: 0.8-1.3)</p>
                                <p>This week's training load is ${((parseFloat(acRatio) - 1) * 100).toFixed(0)}% above your recent average</p>
                                <p><strong>IMMEDIATE ACTIONS:</strong></p>
                                <ul style="margin-left: 20px; margin-top: 10px;">
                                    <li>Reduce volume by 20-25% next week</li>
                                    <li>Add 1-2 extra rest/walking days</li>
                                    <li>Focus on sleep (8+ hours), nutrition, mobility</li>
                                    <li>Monitor: elevated resting HR, mood changes, persistent fatigue</li>
                                    <li>Consider deload week if symptoms present</li>
                                </ul>
                            </div>
                        ` : `
                            <div class="success-box">
                                <h3>‚úì TRAINING LOAD OPTIMAL</h3>
                                <p>Your acute:chronic ratio (${acRatio}) is within safe ranges (0.8-1.3)</p>
                                <p>Continue current training approach while monitoring recovery markers</p>
                            </div>
                        `}
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">METRIC INTERPRETATION:</h3>
                            <p><strong>TSS:</strong> Training Stress Score - cumulative training load</p>
                            <p><strong>A:C Ratio:</strong> This week vs 4-week average. 0.8-1.3 = optimal. >1.5 = high injury risk</p>
                            <p><strong>Monotony:</strong> Training variation. Lower = better. High monotony + high strain = overtraining</p>
                            <p><strong>Fitness:</strong> Adaptations from training (builds slowly over weeks)</p>
                            <p><strong>Fatigue:</strong> Accumulated stress (dissipates quickly with rest)</p>
                            <p><strong>Performance:</strong> Fitness minus fatigue. Positive = peak ready. Negative = need recovery</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('weekly-modal').innerHTML = html;
            document.getElementById('weekly-modal').classList.remove('hidden');
        }
        
        // Calculate Fitness-Fatigue Model (Banister Model)
        function calculateFitnessFatigue(tssHistory) {
            if (tssHistory.length < 7) {
                return { fitness: 0, fatigue: 0, performance: 0, fitnessChange: 0, fatigueChange: 0 };
            }
            
            // Fitness decay constant (42 days)
            // Fatigue decay constant (7 days)
            const fitnessDecay = 42;
            const fatigueDecay = 7;
            
            let fitness = 0;
            let fatigue = 0;
            
            // Calculate using exponential weighted average
            tssHistory.forEach((entry, i) => {
                const daysAgo = tssHistory.length - i - 1;
                fitness += entry.tss * Math.exp(-daysAgo / fitnessDecay);
                fatigue += entry.tss * Math.exp(-daysAgo / fatigueDecay);
            });
            
            // Previous week for comparison
            const prevWeekStart = Math.max(0, tssHistory.length - 14);
            const prevWeekEnd = Math.max(0, tssHistory.length - 7);
            const prevWeekData = tssHistory.slice(prevWeekStart, prevWeekEnd);
            
            let prevFitness = 0;
            let prevFatigue = 0;
            prevWeekData.forEach((entry, i) => {
                const daysAgo = prevWeekData.length - i - 1;
                prevFitness += entry.tss * Math.exp(-daysAgo / fitnessDecay);
                prevFatigue += entry.tss * Math.exp(-daysAgo / fatigueDecay);
            });
            
            const performance = Math.round(fitness - fatigue);
            const fitnessChange = Math.round(fitness - prevFitness);
            const fatigueChange = Math.round(fatigue - prevFatigue);
            
            return {
                fitness: Math.round(fitness),
                fatigue: Math.round(fatigue),
                performance,
                fitnessChange,
                fatigueChange
            };
        }
        
        // Assess recovery status
        function assessRecoveryStatus(dailyCNS, days) {
            if (days === 0) return { status: 'UNKNOWN', color: '#888' };
            
            const avgCNS = dailyCNS.reduce((a, b) => a + b, 0) / days;
            const recentCNS = dailyCNS.slice(-2); // Last 2 workouts
            const recentAvg = recentCNS.reduce((a, b) => a + b, 0) / recentCNS.length;
            
            // Check for upward trend (getting worse)
            const trend = recentAvg - avgCNS;
            
            if (avgCNS > 80 || trend > 15) {
                return { status: 'POOR', color: '#ff4444' };
            } else if (avgCNS > 70 || trend > 10) {
                return { status: 'MODERATE', color: '#ffaa00' };
            } else if (avgCNS > 60) {
                return { status: 'GOOD', color: '#00ccff' };
            } else {
                return { status: 'EXCELLENT', color: '#00ff88' };
            }
        }
        
        // Predict next week performance
        function predictPerformance(fitnessFatigue, acRatio, recoveryStatus) {
            let recommendations = [];
            let nextWeekForecast = '';
            
            const perf = fitnessFatigue.performance;
            const acNum = parseFloat(acRatio);
            
            if (perf > 20 && recoveryStatus.status === 'EXCELLENT' && acNum < 1.2) {
                nextWeekForecast = 'PEAK PERFORMANCE';
                recommendations.push('Perfect time for PRs and max effort tests');
                recommendations.push('Consider testing 1RMs or competition');
                recommendations.push('Maintain current load, avoid increasing volume');
            } else if (perf > 0 && recoveryStatus.status !== 'POOR') {
                nextWeekForecast = 'GOOD STATE';
                recommendations.push('Continue progressive overload');
                recommendations.push('Can increase intensity slightly (2-5%)');
                recommendations.push('Monitor recovery markers closely');
            } else if (perf < 0 && perf > -15) {
                nextWeekForecast = 'FATIGUE BUILDING';
                recommendations.push('Reduce volume by 15-20%');
                recommendations.push('Add extra rest day or walking');
                recommendations.push('Focus on technique, reduce intensity');
            } else if (perf <= -15) {
                nextWeekForecast = 'DELOAD NEEDED';
                recommendations.push('MANDATORY deload week (50% volume reduction)');
                recommendations.push('No CNS > 65 sessions');
                recommendations.push('Focus on recovery: sleep, nutrition, mobility');
                recommendations.push('Walking and light BJJ only');
            }
            
            const html = `
                <div class="${perf > 0 ? 'success-box' : 'warning-box'}">
                    <h3 style="color: ${perf > 0 ? '#00ff88' : '#ff6b35'};">üìà NEXT WEEK FORECAST: ${nextWeekForecast}</h3>
                    <p style="margin-bottom: 10px;"><strong>Performance Index:</strong> ${fitnessFatigue.performance} (${perf > 0 ? 'Ready for hard training' : 'Need recovery'})</p>
                    <p style="font-weight: bold; margin-bottom: 10px;">RECOMMENDATIONS:</p>
                    <ul style="margin-left: 20px;">
                        ${recommendations.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            return { html, forecast: nextWeekForecast, recommendations };
        }
        
        // ========== INIT ==========
        window.onload = function() {
            loadData();
            renderCalendar();
        };
    </script>
</body>
</html>
